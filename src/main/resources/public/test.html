<!DOCTYPE html>
<head>
    <title>Pusher Test</title>
    <script src="https://rawgit.com/mzabriskie/axios/master/dist/axios.js"></script>
    <script src="http://js.pusher.com/2.2/pusher.js"></script>
    <script src="http://localhost:4567/forge.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/cipher-core.js"/>-->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/aes.js"></script>-->


    <script>
        Pusher.XHR = function()  {
                var xhr = new XMLHttpRequest()
                xhr.withCredentials = true
                return xhr
        }
        // Enable pusher logging - don't include this in production
        Pusher.log = function(message) {
            if (window.console && window.console.log) {
                window.console.log(message);
            }
        };
                                   //something
        var pusher = new Pusher('6d0b98669f566dfd8421');
        var channel = pusher.subscribe('project-one');
        var state = {};
        channel.bind('test_event', function(data) {
            alert(data.message);
        });
        console.log("channel2");
        var channel2 = pusher.subscribe('project-two');
        channel2.bind('test_event', function(data) {
            alert(data.message);
        });

        d3 = function() {
            var cipherText = document.getElementById("encryptedOutput").innerText;
            var key  = CryptoJS.enc.Base64.parse(state.secret);
            var options = { iv: CryptoJS.enc.Base64.parse(state.iv),
                mode: CryptoJS.mode.CBC,
                padding: CryptoJS.pad.Pkcs7};
            var pt = CryptoJS.AES.decrypt(
                    {
                        ciphertext: CryptoJS.enc.Base64.parse(cipherText),
                        salt: ""
                    },
                    key,
                    options
              );
        }

        decipher = function(message) {
          return message;
        }
        decipher2 = function() {
            var cipherText = document.getElementById("encryptedOutput").innerText;
            var key  = forge.util.hexToBytes(state.secret);
            var decipher = forge.cipher.createDecipher('AES-CBC', key);
            var cipherBytes = forge.util.decode64(cipherText);
            var iv = forge.util.createBuffer();
            var data = forge.util.createBuffer();
            iv.putBytes(forge.util.hexToBytes(state.iv));
            data.putBytes(cipherBytes);

            decipher.start({iv:iv});
            decipher.update(data);
            decipher.finish();
            // outputs decrypted hex
            console.log(decipher.output.toHex());
            var plaintext = forge.util.decode64(decipher.output.toHex());
        }
        subscribe = function() {
            var privateChannel = pusher.subscribe('private-project1');
            privateChannel.bind('update', function(data) {
                var message = decipher(data.message);
                alert("private" + message);
            });
        }


        var request = window.axios;
        triggerFromBackend = function() {
              axios.get('/hello').then(function(res) {
                  console.log("yay");
              })
        }
        triggerPrivateFromBackend = function() {
            axios.get('/private').then(function(res) {
                console.log("private");
            })
        }
        login = function(username) {
            axios.get('/login/' + username).then(function(res ) {
                console.log("headers", res.headers);
                console.log("I am now" , username)
                state.username = res.data.username;
                state.secret = res.data.secret;
                state.iv = res.data.iv;
                document.cookie = "username=" + state.username;
            });
//            window.location.replace('/login/' + username);
        }
        encryptInput = function() {
            var plainText = document.getElementById("encryptInput").value;
            axios.get('/encrypt/' + plainText).then(function(res ) {
                var cipherText = res.data;
                document.getElementById("encryptedOutput").innerText = cipherText;
            });
        }

    </script>

    <body>
    <input type="button" onClick="triggerFromBackend()" value="call backend" />
    <input type="button" onClick="triggerPrivateFromBackend()" value="call private backend" />
    <input type="button" onclick="subscribe()" value="private subscribe"/>

    <input type="button" onclick="login('sean')" value="i am sean"/>
    <input type="button" onclick="login('linus')" value="i am linus"/>
    <input type="textfield" id="encryptInput">
    <input type="button" onclick="encryptInput()" value="encrypt"/>
    <span id="encryptedOutput">nothing yet</span>
    </body>
</head>
